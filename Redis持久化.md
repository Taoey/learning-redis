# Redis持久化



## 一、RDB快照（snapshotting）

### 1、什么是RDB

RDB是Redis内存到硬盘的快照。

### 2、RDB触发的三种方式

- save（同步）：不推荐使用，在数据量比较大的时候会造成阻塞 
- **bgsave**（异步 background save） 
- 配置文件自动触发 （不能控制备份频率，不推荐使用）

**解析：**

- save命令会**阻塞当前redis进程**，不推荐使用如果有老文件则进行替换，save命令的时间复杂度为O(n)，在一次备份大约**900MB**的内容时，消耗大约**8s**时间，主进程如果阻塞8s，对于高QBS的系统是致命的
- bgsave命令会在后台使用linux的**fork()**开启一个进程进行数据同步，一般认为fork的速度比较快，不会阻塞redis主进程，基本上 Redis     内部所有的RDB操作都是采用 bgsave 命令。
- 配置文件自动触发的方式如下：

```
save 900 1
save 300 10
save 60 10000
```

含义为 900秒内有一个变更，或者300秒内有10个变更，或者60秒内有10000个变更时进行数据同步。

bgsave常用配置：

```bash
# bgsave 写入发生错误时是否停止写入，默认yes
stop-writes-on-bgsave-error yes
# rdb 是否采用压缩模式存储，默认yes
rdbcompression yes
# rdb 校验和检验，默认yes
rdbchecksum yes
# 存储路径，一般选用一个大存储量的位置
dir /bigdiskpath
# 存储文件名称，需要带端口号进行区分
dbfilename dump-${port}.rdb
```

其他不可忽视的触发机制：

- 全量复制：主从复制时，主节点会自动生成rdb文件
- debug reload
- shutdown 

### 3、数据恢复

将备份文件 (dump.rdb) 移动到 redis 安装目录并启动服务即可，redis就会自动加载文件数据至内存了。Redis 服务器在载入 RDB 文件期间，会一直处于阻塞状态，直到载入工作完成为止。



### 4、RDB 的优势和劣势

#### 优势

1）RDB是一个非常紧凑(compact)的文件，它保存了redis 在某个时间点上的数据集。这种文件非常适合用于进行备份和灾难恢复。

2）生成RDB文件的时候，redis主进程会fork()一个子进程来处理所有保存工作，主进程不需要进行任何磁盘IO操作。

3）RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快。

#### 劣势

1、RDB方式数据**没办法做到实时持久化/秒级持久化**。因为bgsave每次运行都要执行fork操作创建子进程，属于**重量级操作**(内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑)，频繁执行成本过高(影响性能)

2、RDB文件使用特定二进制格式保存，Redis版本演进过程中有多个格式的RDB版本，存在老版本Redis服务无法兼容新版RDB格式的问题(**版本不兼容**)

3、在一定间隔时间做一次备份，所以如果redis意外down掉的话，就会丢失最后一次快照后的所有修改(**数据有丢失**)



## 二、AOF









## 参考资料